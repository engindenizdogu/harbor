<nav class="sidebar-nav" aria-label="Notes">
  {%- comment -%}
    Hierarchical sidebar
    --------------------
    We build a nested folder â†’ notes listing from the `site.notes` collection.
    Only notes under `_notes/Public/` are shown. Subfolders inside `Public/` become
    collapsible sections. Root-level notes (directly under `Public/`) are listed first.

    Liquid limitations: We simulate a set of unique folder names using an array we push into.
    Paths may contain either forward or backslashes depending on OS, so we check both.
    "Relative path" here means the portion after `_notes/Public/`.
  {%- endcomment -%}

  {%- assign public_notes = site.notes | where_exp: "n", "n.path contains '/Public/' or n.path contains '\\Public\\'" -%}
  {%- assign public_notes = public_notes | sort: 'title' -%}

  {%- comment -%} Build unique folder list {%- endcomment -%}
  {%- assign folders = '' | split: '' -%}
  {%- for n in public_notes -%}
    {%- assign rel = n.path | replace: '_notes/Public/', '' | replace: '_notes\\Public\\', '' -%}
    {%- if rel contains '/' or rel contains '\\' -%}
      {%- if rel contains '/' -%}
        {%- assign folder = rel | split: '/' | first -%}
      {%- else -%}
        {%- assign folder = rel | split: '\\' | first -%}
      {%- endif -%}
      {%- unless folders contains folder -%}
        {%- assign folders = folders | push: folder -%}
      {%- endunless -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign folders = folders | sort -%}

  <ul class="sidebar-list">
    {%- comment -%} Folder sections {%- endcomment -%}
    {%- for folder in folders -%}
      <li class="sidebar-folder">
        <details class="sidebar-details" data-folder-name="{{ folder }}" {% if page.path contains folder %}open{% endif %}>
          <summary class="sidebar-folder-name">{{ folder }}</summary>
          <ul class="sidebar-sublist">
            {%- for note in public_notes -%}
              {%- assign rel = note.path | replace: '_notes/Public/', '' | replace: '_notes\\Public\\', '' -%}
              {%- if rel contains '/' or rel contains '\\' -%}
                {%- if rel contains '/' -%}
                  {%- assign segments = rel | split: '/' -%}
                {%- else -%}
                  {%- assign segments = rel | split: '\\' -%}
                {%- endif -%}
                {%- if segments[0] == folder -%}
                  <li class="sidebar-item sidebar-subitem{%- if page.url == note.url -%} active{%- endif -%}">
                    <a class="sidebar-link" href="{{ site.baseurl }}{{ note.url }}">{{ note.title }}</a>
                  </li>
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          </ul>
        </details>
      </li>
    {%- endfor -%}

    {%- comment -%} Root-level notes (no subfolder) after folders {%- endcomment -%}
    {%- for note in public_notes -%}
      {%- assign rel = note.path | replace: '_notes/Public/', '' | replace: '_notes\\Public\\', '' -%}
      {%- unless rel contains '/' or rel contains '\\' -%}
        <li class="sidebar-item{%- if page.url == note.url -%} active{%- endif -%}">
          <a class="sidebar-link" href="{{ site.baseurl }}{{ note.url }}">{{ note.title }}</a>
        </li>
      {%- endunless -%}
    {%- endfor -%}
  </ul>
</nav>

<script>
  (function () {
    // Persist sidebar folder open/closed state across page navigations
    var STORAGE_KEY = 'sidebarOpenFolders';
    function readOpenSet() {
      try {
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return new Set();
        var arr = JSON.parse(raw);
        return new Set(Array.isArray(arr) ? arr : []);
      } catch (e) {
        return new Set();
      }
    }
    function writeOpenSet(set) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(set)));
      } catch (e) {
        // ignore write errors (e.g., private mode)
      }
    }

    function init() {
      var detailsList = document.querySelectorAll('.sidebar-details[data-folder-name]');
      if (!detailsList.length) return;

      var openSet = readOpenSet();

      detailsList.forEach(function (det) {
        var name = det.getAttribute('data-folder-name');
        if (!name) return;
        // Apply persisted state (if exists)
        if (openSet.has(name)) {
          det.setAttribute('open', '');
        } else {
          // If not in persisted set, keep whatever Liquid rendered
          // and later we will sync current open states on first run
        }

        // Update persistence on user toggle
        det.addEventListener('toggle', function () {
          if (det.open) {
            openSet.add(name);
          } else {
            openSet.delete(name);
          }
          writeOpenSet(openSet);
        });
      });

      // Prime storage the first time (to reflect any default-open sections)
      if (openSet.size === 0) {
        var initiallyOpen = Array.prototype.filter.call(detailsList, function (d) { return d.open; })
          .map(function (d) { return d.getAttribute('data-folder-name'); });
        if (initiallyOpen.length) {
          writeOpenSet(new Set(initiallyOpen));
        }
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
